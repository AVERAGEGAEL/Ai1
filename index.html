<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Hub | Gemini 3 Ready</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Marked.js for Markdown Rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Markdown Styles within Chat */
        .prose p { margin-bottom: 0.5rem; }
        .prose pre { background: #111827; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .prose code { background: #374151; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.875em; }
        .prose pre code { background: transparent; padding: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        
        /* Typing Animation */
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 p-4 shadow-lg z-10">
        <div class="max-w-5xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
            
            <!-- Logo / Branding -->
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-tr from-blue-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-robot text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">AI Chat Hub</h1>
                    <p class="text-xs text-gray-400">Powered by Cloudflare Workers</p>
                </div>
            </div>

            <!-- Model Selector -->
            <div class="relative w-full sm:w-64">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fa-solid fa-microchip text-gray-400 text-sm"></i>
                </div>
                <select id="model-select" class="block w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm appearance-none cursor-pointer transition-colors hover:bg-gray-600">
                    <option value="gemini-3-pro-preview" selected>Gemini 3.0 Pro (New!)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fast)</option>
                </select>
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <i class="fa-solid fa-chevron-down text-gray-400 text-xs"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Chat Area -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 sm:p-6 scroll-smooth">
        <div class="max-w-3xl mx-auto space-y-6">
            
            <!-- Welcome Message -->
            <div class="flex gap-4">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex-shrink-0 flex items-center justify-center">
                    <i class="fa-solid fa-robot text-xs text-white"></i>
                </div>
                <div class="bg-gray-800 p-4 rounded-2xl rounded-tl-none border border-gray-700 shadow-sm max-w-[85%]">
                    <p class="text-sm sm:text-base leading-relaxed">
                        Hello! I'm ready to chat. I'm currently powered by <span class="font-bold text-blue-400">Gemini 3.0 Pro</span>. Pick a model above and ask me anything!
                    </p>
                </div>
            </div>

            <!-- Messages will be injected here -->
            
        </div>
    </main>

    <!-- Input Area -->
    <footer class="bg-gray-800 border-t border-gray-700 p-4">
        <div class="max-w-3xl mx-auto relative">
            <form id="chat-form" class="relative flex items-end gap-2 bg-gray-900 border border-gray-600 rounded-xl p-2 focus-within:ring-2 focus-within:ring-blue-500/50 transition-shadow shadow-inner">
                
                <textarea 
                    id="user-input" 
                    rows="1" 
                    placeholder="Type your message here..." 
                    class="w-full bg-transparent text-white placeholder-gray-500 text-sm sm:text-base p-2 resize-none focus:outline-none max-h-32 overflow-y-auto"
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                    onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); this.form.dispatchEvent(new Event('submit')); }"
                ></textarea>

                <button 
                    type="submit" 
                    id="send-btn"
                    class="bg-blue-600 hover:bg-blue-500 text-white p-2.5 rounded-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0 group"
                >
                    <i class="fa-solid fa-paper-plane text-sm group-hover:translate-x-0.5 transition-transform"></i>
                </button>
            </form>
            <p class="text-center text-xs text-gray-500 mt-2">
                AI can make mistakes. Please double-check responses.
            </p>
        </div>
    </footer>

    <!-- JavaScript Logic -->
    <script>
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const modelSelect = document.getElementById('model-select');
        
        // WORKER URL
        const API_URL = "https://ai1.uraverageopdoge.workers.dev/";

        // Store chat history locally to send as context (since backend is stateless)
        let chatHistory = [];

        function addMessage(role, text) {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex gap-4 ' + (role === 'user' ? 'flex-row-reverse' : '');
            
            const avatar = document.createElement('div');
            avatar.className = `w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center ${
                role === 'user' ? 'bg-gray-600' : 'bg-gradient-to-tr from-blue-500 to-purple-600'
            }`;
            avatar.innerHTML = role === 'user' 
                ? '<i class="fa-solid fa-user text-xs text-white"></i>' 
                : '<i class="fa-solid fa-robot text-xs text-white"></i>';

            const bubble = document.createElement('div');
            bubble.className = `p-4 rounded-2xl border shadow-sm max-w-[85%] text-sm sm:text-base leading-relaxed overflow-hidden ${
                role === 'user' 
                    ? 'bg-blue-600 text-white border-blue-500 rounded-tr-none' 
                    : 'bg-gray-800 text-gray-100 border-gray-700 rounded-tl-none prose prose-invert'
            }`;

            if (role === 'ai') {
                // Parse Markdown for AI responses
                bubble.innerHTML = marked.parse(text);
            } else {
                bubble.textContent = text;
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
            
            // Append to the inner container
            chatContainer.firstElementChild.appendChild(wrapper);
            
            // Scroll to bottom
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        function showLoading() {
            const wrapper = document.createElement('div');
            wrapper.id = 'loading-indicator';
            wrapper.className = 'flex gap-4';
            wrapper.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-600 flex-shrink-0 flex items-center justify-center">
                    <i class="fa-solid fa-robot text-xs text-white"></i>
                </div>
                <div class="bg-gray-800 p-4 rounded-2xl rounded-tl-none border border-gray-700 flex items-center gap-1 h-12">
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                </div>
            `;
            chatContainer.firstElementChild.appendChild(wrapper);
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        function removeLoading() {
            const loader = document.getElementById('loading-indicator');
            if (loader) loader.remove();
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            const model = modelSelect.value;

            if (!message) return;

            // 1. UI Updates
            addMessage('user', message);
            userInput.value = '';
            userInput.style.height = 'auto'; // Reset height
            sendBtn.disabled = true;
            showLoading();

            // 2. Prepare History Context
            // Because the backend is stateless, we stitch history together.
            chatHistory.push({ role: 'user', content: message });
            
            // Create a text prompt that includes history
            // Format: 
            // User: Hi
            // Model: Hello
            // User: How are you?
            const contextPayload = chatHistory.map(msg => 
                `${msg.role === 'user' ? 'User' : 'Model'}: ${msg.content}`
            ).join('\n');

            try {
                // 3. Fetch from Worker
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: contextPayload, // Sending full context
                        model: model 
                    })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                
                removeLoading();

                if (data.error) {
                    addMessage('ai', `**Error:** ${data.error}`);
                } else {
                    const reply = data.reply;
                    addMessage('ai', reply);
                    chatHistory.push({ role: 'ai', content: reply });
                }

            } catch (error) {
                removeLoading();
                addMessage('ai', `**System Error:** Could not connect to the AI. Please try again later.\n\n*Debug: ${error.message}*`);
            } finally {
                sendBtn.disabled = false;
                userInput.focus();
            }
        });
    </script>
</body>
</html>
